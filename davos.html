<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <title>Strela Walk</title>
</head>
<body>

    <canvas id="canvas" style="width: 100%; height: 100%;"></canvas>

    <script src="lib/three.min.js"></script>
    <script src="lib/OrbitControls.js"></script>
    <!-- <script src="../deps/stats.min.js"></script> -->
    <script src="lib/threelet.min.js"></script>

    <script src="lib/three-geo.min.js"></script>

    <script src="lib/d3.v3.js"></script>
    <!-- <script src="../../target/three-geo.js"></script> -->

    <script>
        //https://github.com/w3reality/three-geo
    const threelet = new Threelet({
        canvas: document.getElementById("canvas"),
        optAxes: false
    });
    /*const canvas = document.getElementById("canvas");
    const camera = new THREE.PerspectiveCamera(45, canvas.width/canvas.height, 1, 1000);
        camera.position.set(0, 1.5, 1.5);

    const renderer = new THREE.WebGLRenderer({ canvas });
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    const scene = new THREE.Scene();*/

    threelet.setup('mod-controls', THREE.OrbitControls);
    // threelet.setup('mod-stats', window.Stats);

    const { scene, render } = threelet;
    /*    const render = () => {
            //stats.update();
            renderer.render(scene, camera);
        };

        controls.addEventListener('change', render);
        render(); // first time*/


        const ioToken = 'pk.eyJ1IjoiamRldmVsIiwiYSI6ImNqemFwaGJoZjAyc3MzbXA1OGNuODBxa2EifQ.7M__SgfWZGJuEiSqbBXdoQ';
    const tgeo = new ThreeGeo({
        tokenMapbox: 'pk.eyJ1IjoiaHp1ZWxsaWciLCJhIjoiY2tjbmt1MjQwMGMzcDJybGZtcGR3NmR4aCJ9.HMZtdVsH8vPFyK5r5KmOHA' // <---- set your Mapbox API token here

    });

    if (tgeo.tokenMapbox === ioToken && window.location.origin !== 'https://w3reality.github.io') {
        const warning = 'Please set your own Mapbox API token in the ThreeGeo constructor.';
        alert(warning);
        throw warning;
    }

    const origin = [46.802745, 9.835970];
    const radius = 2.0;

    var myColor = d3.scale.linear().domain([1500,2500]).range(["green", "grey", "white"]);

    (async () => {
        const terrain = await tgeo.getTerrainRgb(origin, radius, 12);
        terrain.rotation.x = - Math.PI/2;
        terrain.children.forEach(mesh => {
            mesh.material.wireframe = true;
        });
        scene.add(terrain);



        d3.xml('assets/Strela.gpx', 'application/xml', gpxParser);



    })();

        function gpxParser(gpx) {
            var tracks = gpx.getElementsByTagName('trk');



            const { proj, unitsPerMeter } = tgeo.getProjection(origin, radius);

            for (i = 0; i < tracks.length; i=i+100) {
                var points = tracks[i].getElementsByTagName('trkpt')
                for (x = 0; x < points.length; x++) { // points.length
                    var point = points[x],
                        alt = parseInt(point.getElementsByTagName('ele')[0].firstChild.nodeValue),
                        lat = parseFloat(point.getAttribute('lat')),
                        lng = parseFloat(point.getAttribute('lon')),
                        coord = proj([lat, lng]);


                    let c = myColor(alt);

                    let dot = new THREE.Points(
                        new THREE.Geometry(),
                        new THREE.PointsMaterial({
                            size: 5,
                            sizeAttenuation: false,
                            color: c,
                        }));

                    dot.geometry.vertices.push(new THREE.Vector3(
                        coord[0], (alt + 50) * unitsPerMeter , -coord[1]));
                    scene.add(dot);

               }
            }


            render();


        }

    </script>
</body>
</html>
